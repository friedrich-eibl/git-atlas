<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>GitAtlas</title>
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<script
			defer
			src="https://static.cloudflareinsights.com/beacon.min.js"
			data-cf-beacon='{"token": "YOUR_TOKEN"}'
		></script>

		<style>
			:root {
				--bg: #ffffff;
				--fg: #24292f;
				--muted: #57606a;
				--border: #d0d7de;
				--panel: #f6f8fa;
				--canvas: #ffffff;
				--accent: #24292f;
			}

			* {
				box-sizing: border-box;
			}

			html,
			body {
				height: 100%;
			}

			body {
				margin: 0;
				font-family:
					system-ui,
					-apple-system,
					Segoe UI,
					Roboto,
					Helvetica,
					Arial;
				background: var(--bg);
				color: var(--fg);
			}

			/* grid background (behind everything) */
			body::before {
				content: "";
				position: fixed;
				inset: 0;
				z-index: 0;
				pointer-events: none;
				background:
					linear-gradient(#eef2f6 1px, transparent 1px),
					linear-gradient(90deg, #eef2f6 1px, transparent 1px);
				background-size: 48px 48px;
				opacity: 0.45;
			}

			/* app layer */
			.app {
				position: relative;
				z-index: 1;
			}

			/* ---------- header ---------- */
			header {
				display: flex;
				justify-content: space-between;
				align-items: baseline;
				padding: 14px 20px;
				border-bottom: 1px solid var(--border);
				background: #fff;
			}

			h1 {
				margin: 0;
				font-size: 16px;
				letter-spacing: 0.08em;
				text-transform: uppercase;
			}

			header .tag {
				font-size: 12px;
				color: var(--muted);
			}

			/* ---------- workspace ---------- */
			.workspace {
				display: grid;
				grid-template-columns: 290px 1fr;
				min-height: calc(100vh - 56px);
			}

			/* ---------- rail ---------- */
			.rail {
				border-right: 1px solid var(--border);
				background: #fbfcfd;
				padding: 14px;
				display: flex;
				flex-direction: column;
				gap: 14px;
			}

			.section {
				border-top: 1px solid var(--border);
				padding-top: 12px;
			}
			.section:first-child {
				border-top: none;
				padding-top: 0;
			}

			.label {
				font-size: 11px;
				letter-spacing: 0.08em;
				text-transform: uppercase;
				color: var(--muted);
				margin-bottom: 6px;
			}

			input {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid var(--border);
				background: #fff;
				font-size: 13px;
				outline: none;
			}
			input:focus {
				border-color: #8c959f;
			}

			button {
				width: 100%;
				padding: 10px 12px;
				border: 1px solid var(--accent);
				background: var(--accent);
				color: #fff;
				font-weight: 600;
				cursor: pointer;
			}
			button.secondary {
				background: #fff;
				color: var(--accent);
				border: 1px solid var(--border);
			}
			button:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}
			button + button {
				margin-top: 8px;
			}

			.status {
				font-size: 12px;
				color: var(--muted);
			}

			.path {
				font-family:
					ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
					monospace;
				font-size: 12px;
				background: var(--panel);
				border: 1px solid var(--border);
				padding: 8px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}

			/* ---------- canvas ---------- */
			.canvas-wrap {
				padding: 16px;
				background: #fff;
			}

			.canvas-frame {
				height: calc(100vh - 88px);
				background: var(--canvas);
				border: 1px solid var(--border);
				position: relative;
				overflow: hidden;
			}

			.canvas-frame::before {
				content: "";
				position: absolute;
				inset: 0;
				pointer-events: none;
				z-index: 0;
				background:
					linear-gradient(transparent 95%, #f1f3f5 95%),
					linear-gradient(90deg, transparent 95%, #f1f3f5 95%);
				background-size: 80px 80px;
			}

			.canvas-frame > svg {
				position: relative;
				z-index: 1;
			}

			/* ---------- tooltip ---------- */
			.tooltip {
				position: fixed;
				pointer-events: none;
				background: rgba(27, 31, 36, 0.92);
				color: #fff;
				padding: 6px 8px;
				font-size: 12px;
				display: none;
				z-index: 9999;
				font-family:
					ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
					monospace;
			}

			/* =========================================================
   RESPONSIVE — THIS IS THE IMPORTANT PART
   ========================================================= */

			@media (max-width: 900px) {
				/* switch layout completely */
				.workspace {
					display: flex;
					flex-direction: column;
					min-height: auto;
				}

				/* rail becomes top bar */
				.rail {
					flex-direction: row;
					flex-wrap: wrap;
					border-right: none;
					border-bottom: 1px solid var(--border);
					align-items: flex-start;
					gap: 12px;
				}

				.section {
					border-top: none;
					padding-top: 0;
					flex: 1 1 240px;
					min-width: 240px;
				}

				.section:first-child {
					flex: 1 1 100%;
					min-width: 100%;
				}

				button {
					width: auto;
				}

				button + button {
					margin-top: 0;
				}

				.canvas-wrap {
					padding: 10px;
				}

				.canvas-frame {
					height: 72vh;
				}
			}

			@media (max-width: 520px) {
				.rail {
					padding: 10px;
					gap: 8px;
				}

				.section {
					flex: 1 1 100%;
					min-width: 100%;
				}

				.canvas-frame {
					height: 68vh;
				}
			}
		</style>
	</head>

	<body>
		<div class="app">
			<header>
				<h1>Git-Atlas</h1>
				<div class="tag">Git repository structure visualizer</div>
			</header>

			<div class="workspace">
				<aside class="rail">
					<div class="section">
						<div class="label">Repository</div>
						<input
							id="repoUrl"
							value="https://github.com/git/git"
						/>
						<button id="go">Visualize</button>
						<button id="local" class="secondary">
							Load Local Project
						</button>
					</div>

					<div class="section">
						<div class="label">Navigation</div>
						<div id="path" class="path">repo</div>
						<button id="back" class="secondary" disabled>
							Back
						</button>
						<button id="root" class="secondary" disabled>
							Root
						</button>
						<div class="label">Search</div>
						<input
							id="search"
							placeholder="Find file… (e.g. main.ts)"
							autocomplete="off"
						/>
					</div>

					<div class="section">
						<div class="label">Export</div>
						<button id="export" class="secondary">
							Export SVG
						</button>
					</div>

					<div class="section">
						<div class="label">Status</div>
						<div id="status" class="status">Idle</div>
						<div id="message"></div>
					</div>
				</aside>

				<main class="canvas-wrap">
					<div id="viz" class="canvas-frame"></div>
				</main>
			</div>
		</div>

		<div id="tooltip" class="tooltip"></div>

		<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
		<script src="scripts/linguist-colors.js"></script>

		<script src="scripts/github.js"></script>
		<script src="scripts/tree.js"></script>
		<script src="scripts/export.js"></script>
		<script src="scripts/render.js"></script>

		<script>
			const $ = (s) => document.querySelector(s);

			const viz = $("#viz"),
				tooltip = $("#tooltip");
			const statusEl = $("#status"),
				msgEl = $("#message"),
				pathEl = $("#path");
			const btn = $("#go"),
				backBtn = $("#back"),
				rootBtn = $("#root"),
				exportBtn = $("#export"),
				localBtn = $("#local");

			let FULL_ROOT = null,
				CURRENT = null;

			function setStatus(t) {
				statusEl.textContent = t;
			}
			function setMessage(t, e = false) {
				msgEl.innerHTML = t
					? e
						? `<div class="err">${t}</div>`
						: t
					: "";
			}
			function rerender() {
				render(
					viz,
					CURRENT,
					FULL_ROOT,
					pathEl,
					backBtn,
					rootBtn,
					tooltip,
					navigateDir,
					pathOf,
					extColor,
					(n) => {
						CURRENT = n;
					},
				);
			}

			async function load() {
				const parsed = parseGitHubUrl($("#repoUrl").value);
				if (!parsed) return setMessage("Invalid GitHub URL", true);
				btn.disabled = true;
				setStatus("Loading…");
				try {
					const repo = await gh(
						`https://api.github.com/repos/${parsed.owner}/${parsed.repo}`,
					);
					const branch = repo.default_branch;
					const info = await gh(
						`https://api.github.com/repos/${parsed.owner}/${parsed.repo}/branches/${branch}`,
					);
					const sha = info.commit.commit.tree.sha;
					const tree = await gh(
						`https://api.github.com/repos/${parsed.owner}/${parsed.repo}/git/trees/${sha}?recursive=1`,
					);

					FULL_ROOT = d3.hierarchy(treeListToHierarchy(tree.tree));
					CURRENT = FULL_ROOT;

					rerender();
					setStatus("Loaded");
				} catch (e) {
					setMessage(e.message, true);
					setStatus("Error");
				} finally {
					btn.disabled = false;
				}
			}

			window.addEventListener("load", load);

			btn.onclick = load;
			backBtn.onclick = () => {
				if (CURRENT.parent) {
					CURRENT = CURRENT.parent;
					rerender();
				}
			};
			rootBtn.onclick = () => {
				CURRENT = FULL_ROOT;
				rerender();
			};
			exportBtn.onclick = exportSVG;
			localBtn.onclick = loadLocal;
		</script>
	</body>
</html>

